<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡èŠ‚ç‚¹ä¼˜é€‰è½¬æ¢</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --primary-hover: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --input-bg: rgba(15, 23, 42, 0.6);
            --radius-lg: 16px;
            --radius-md: 8px;
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }
        
        h1 { 
            font-size: 1.5rem;
            margin: 0;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-bg {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        label {
            font-size: 0.85rem;
            color: var(--text-sub);
            font-weight: 500;
            margin: 0;
        }
        
        .count-badge {
            font-size: 0.75rem;
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            padding: 2px 8px;
            border-radius: 10px;
        }

        textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: #fff;
            padding: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            resize: none;
            flex: 1;
            transition: all 0.2s;
        }

        textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            background: var(--bg-color);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        select option {
            background-color: #1e293b;
        }

        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .btn-convert { 
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8; 
            border: 1px solid rgba(99, 102, 241, 0.4);
            font-size: 0.85rem;
            min-width: 100px;
        }

        .btn-convert:hover {
            background: rgba(99, 102, 241, 0.4);
            color: #fff;
        }

        .btn-extract {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24; 
            border: 1px solid rgba(245, 158, 11, 0.3);
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-extract:hover {
            background: rgba(245, 158, 11, 0.3);
            color: #fff;
        }

        .tabs-container {
            display: flex;
            background: rgba(0,0,0,0.2);
            padding: 4px;
            border-radius: 8px;
            gap: 4px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            color: var(--text-sub);
            cursor: pointer;
            border-radius: 6px;
            transition: 0.2s;
        }

        .tab.active {
            background: var(--input-bg);
            color: #fff;
            font-weight: 600;
        }

        #status-toast {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            textarea { min-height: 150px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸš€ ä¼˜é€‰æ„å»ºå™¨ Pro <span style="font-size:0.5em; opacity:0.7; font-weight:normal;">(Flagpediaç‰ˆ)</span></h1>
        <div id="status-toast">ç³»ç»Ÿå°±ç»ª</div>
    </header>

    <div class="main-layout">
        <div class="card">
            <div class="card-header">
                <div class="card-title"><div class="icon-bg">âš™ï¸</div> åŸå§‹èŠ‚ç‚¹</div>
                <button class="btn btn-secondary" onclick="location.reload()">é‡ç½®</button>
            </div>

            <textarea id="sourceNode" style="height: 100px; flex: none;" placeholder="ç²˜è´´æ¨¡æ¿é“¾æ¥ (ç”¨äºæ‰¹é‡ç”Ÿæˆ)"></textarea>

            <div class="card-header">
                <label>IP åˆ—è¡¨</label>
                <button class="btn-extract" onclick="cleanAndExtract()">âš¡ æå– IP</button>
            </div>
            <textarea id="ipList" placeholder="ç²˜è´´ IP åˆ—è¡¨..."></textarea>

            <div class="settings-grid">
                <div><label style="font-size:0.7rem;">æ³›åŸŸå</label><input type="text" id="wildcardPrefix" value="cdn"></div>
                <div><label style="font-size:0.7rem;">é»˜è®¤ç«¯å£</label><input type="number" id="defaultPort" value="443"></div>
                <div><label style="font-size:0.7rem;">åç¼€</label><input type="text" id="tagSuffix" value="-ä¼˜é€‰"></div>
            </div>

            <button class="btn btn-primary" id="genBtn" onclick="generateNodes()">âš¡ å¼€å§‹è½¬æ¢ (è‡ªåŠ¨å»é‡)</button>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ“¦ ç»“æœè¾“å‡º</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-convert" onclick="independentTransform()">âš¡ æ ¼å¼è½¬æ¢</button>
                    <button class="btn btn-secondary" onclick="copyResult()">å¤åˆ¶</button>
                    <button class="btn btn-secondary" onclick="downloadResult()">ä¸‹è½½</button>
                </div>
            </div>

            <div class="tabs-container">
                <div class="tab active" onclick="switchTab('raw')">é“¾æ¥åˆ—è¡¨</div>
                <div class="tab" onclick="switchTab('b64')">Base64</div>
                <div class="tab" onclick="switchTab('clash')">Clash YAML</div>
            </div>

            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:10px;" id="ruleUrlBox">
                <div style="margin-bottom:8px;">
                    <select id="ruleSelect" onchange="updateRuleUrl()" style="width:100%; background:var(--input-bg); border:1px solid var(--glass-border); color:#fff; padding:8px; border-radius:var(--radius-md); font-size:0.85rem;">
                        <option value="https://raw.githubusercontent.com/byJoey/test/refs/heads/main/tist.ini">ğŸ“‚ byJoey è‡ªç”¨èšåˆ (tist.ini)</option>
                        <option value="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini">ğŸŒ ACL4SSR é»˜è®¤ç‰ˆ</option>
                        <option value="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full.ini" selected>ğŸŒ ACL4SSR å…¨åˆ†ç»„ç‰ˆ</option>
                        <option value="custom">ğŸ“ è‡ªå®šä¹‰è§„åˆ™é“¾æ¥...</option>
                    </select>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" id="ruleUrl" placeholder="è§„åˆ™é“¾æ¥åœ°å€" 
                        style="flex:1; font-size:0.8rem;" 
                        value="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full.ini">
                    <button class="btn btn-convert" onclick="fetchAndApplyRules()" style="min-width:80px;">åŠ è½½è§„åˆ™</button>
                </div>
            </div>

            <textarea id="outputArea" placeholder="ç›´æ¥ç²˜è´´é“¾æ¥æˆ– YAML ç‚¹å‡»â€œæ ¼å¼è½¬æ¢â€..."></textarea>
            
            <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-sub);">
                <span>çŠ¶æ€: <span id="progress-text">é—²ç½®</span></span>
                <span id="genCountDisplay" class="count-badge">0 ä¸ªèŠ‚ç‚¹</span>
            </div>
        </div>
    </div>
</div>

<script>
const Base64 = {
    encode: (s) => btoa(unescape(encodeURIComponent(s))),
    decode: (s) => decodeURIComponent(escape(atob(s)))
};

const hardcodedGroups = ["èŠ‚ç‚¹é€‰æ‹©", "æ‰‹åŠ¨åˆ‡æ¢", "è‡ªåŠ¨é€‰æ‹©", "ç”µæŠ¥æ¶ˆæ¯", "OpenAi", "æ²¹ç®¡è§†é¢‘", "å¥ˆé£è§†é¢‘", "å·´å“ˆå§†ç‰¹", "å“”å“©å“”å“©", "å›½å¤–åª’ä½“", "å›½å†…åª’ä½“", "è°·æ­ŒFCM", "å¾®è½¯Bing", "å¾®è½¯äº‘ç›˜", "å¾®è½¯æœåŠ¡", "è‹¹æœæœåŠ¡", "æ¸¸æˆå¹³å°", "ç½‘æ˜“éŸ³ä¹", "å…¨çƒç›´è¿", "å…¨çƒæ‹¦æˆª", "åº”ç”¨å‡€åŒ–", "æ¼ç½‘ä¹‹é±¼"];

const countryMap = {
    "CN": "ä¸­å›½", "HK": "é¦™æ¸¯", "MO": "æ¾³é—¨", "TW": "å°æ¹¾",
    "JP": "æ—¥æœ¬", "KR": "éŸ©å›½", "SG": "ç‹®åŸ", "IN": "å°åº¦",
    "ID": "å°å°¼", "MY": "é©¬æ¥è¥¿äºš", "TH": "æ³°å›½", "VN": "è¶Šå—",
    "PH": "è²å¾‹å®¾", "PK": "å·´åŸºæ–¯å¦", "IL": "ä»¥è‰²åˆ—", "TR": "åœŸè€³å…¶",
    "AE": "é˜¿è”é…‹", "SA": "æ²™ç‰¹", "IR": "ä¼Šæœ—", "KP": "æœé²œ",
    "CY": "å¡æµ¦è·¯æ–¯", "US": "ç¾å›½", "CA": "åŠ æ‹¿å¤§", "MX": "å¢¨è¥¿å“¥", 
    "GB": "è‹±å›½", "DE": "å¾·å›½", "FR": "æ³•å›½", "NL": "è·å…°",
    "RU": "ä¿„ç½—æ–¯", "IT": "æ„å¤§åˆ©", "ES": "è¥¿ç­ç‰™", "SE": "ç‘å…¸",
    "CH": "ç‘å£«", "IE": "çˆ±å°”å…°", "UA": "ä¹Œå…‹å…°", "PL": "æ³¢å…°",
    "NO": "æŒªå¨", "FI": "èŠ¬å…°", "DK": "ä¸¹éº¦", "PT": "è‘¡è„ç‰™",
    "AT": "å¥¥åœ°åˆ©", "GR": "å¸Œè…Š", "BE": "æ¯”åˆ©æ—¶", "HU": "åŒˆç‰™åˆ©",
    "CZ": "æ·å…‹", "RO": "ç½—é©¬å°¼äºš", "BG": "ä¿åŠ åˆ©äºš", "IS": "å†°å²›",
    "AU": "æ¾³å¤§åˆ©äºš", "NZ": "æ–°è¥¿å…°", "BR": "å·´è¥¿", "AR": "é˜¿æ ¹å»·", 
    "CL": "æ™ºåˆ©", "CO": "å“¥ä¼¦æ¯”äºš", "PE": "ç§˜é²", "ZA": "å—é", 
    "EG": "åŸƒåŠ", "NG": "å°¼æ—¥åˆ©äºš"
};

// ä¿®å¤ï¼šå¼ºåˆ¶ä½¿ç”¨ HTTPSï¼Œå¹¶ç§»é™¤äº†ä¸æ”¯æŒ HTTPS çš„ ip-api.com
const apiProviders = [
    {
        name: 'ipwho.is',
        url: (ip) => `https://ipwho.is/${ip}?lang=zh-CN`,
        parse: (data) => ({ code: data.country_code, name: data.country })
    },
    {
        name: 'ipapi.co',
        url: (ip) => `https://ipapi.co/${ip}/json/`,
        parse: (data) => ({ code: data.country_code, name: data.country_name })
    }
];

function translateCountry(code, name) {
    if (countryMap[code]) return countryMap[code];
    const map = { "United States": "ç¾å›½", "USA": "ç¾å›½", "Hong Kong": "é¦™æ¸¯", "Japan": "æ—¥æœ¬", "Singapore": "æ–°åŠ å¡", "Taiwan": "å°æ¹¾", "China": "ä¸­å›½", "Korea": "éŸ©å›½", "United Kingdom": "è‹±å›½", "Germany": "å¾·å›½" };
    return map[name] || name || code; 
}

function getFlagEmoji(countryCode) {
    if (!countryCode) return 'ğŸ‡ºğŸ‡¸'; 
    if (countryCode === 'TW') return 'ğŸ‡¨ğŸ‡³'; 
    const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
    return String.fromCodePoint(...codePoints);
}

function getFlagIconUrl(countryCode) {
    if (!countryCode) return null;
    return `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`;
}

function updateRuleUrl() {
    const select = document.getElementById('ruleSelect');
    const input = document.getElementById('ruleUrl');
    if (select.value !== 'custom') { input.value = select.value; } 
    else { input.value = ''; input.placeholder = 'è¯·åœ¨æ­¤ç²˜è´´è‡ªå®šä¹‰è§„åˆ™é“¾æ¥...'; input.focus(); }
}

let activeRules = [
    { name: "LS_Direct", group: "å…¨çƒç›´è¿", url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/direct.txt", type: "domain", format: "yaml" },
    { name: "LS_NonCN", group: "èŠ‚ç‚¹é€‰æ‹©", url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/tld-not-cn.txt", type: "domain", format: "yaml" },
    { name: "LS_Proxy", group: "èŠ‚ç‚¹é€‰æ‹©", url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt", type: "domain", format: "yaml" },
    { name: "Lan", group: "å…¨çƒç›´è¿", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/LocalAreaNetwork.list", type: "classical", format: "text" },
    { name: "UnBan", group: "å…¨çƒç›´è¿", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/UnBan.list", type: "classical", format: "text" },
    { name: "LS_Reject", group: "åº”ç”¨å‡€åŒ–", url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/reject.txt", type: "domain", format: "yaml" },
    { name: "Advertising", group: "åº”ç”¨å‡€åŒ–", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanAD.list", type: "classical", format: "text" },
    { name: "GoogleFCM", group: "è°·æ­ŒFCM", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/GoogleFCM.list", type: "classical", format: "text" },
    { name: "Google", group: "èŠ‚ç‚¹é€‰æ‹©", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Google.list", type: "classical", format: "text" },
    { name: "Bing", group: "å¾®è½¯Bing", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Bing.list", type: "classical", format: "text" },
    { name: "OneDrive", group: "å¾®è½¯äº‘ç›˜", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/OneDrive.list", type: "classical", format: "text" },
    { name: "Microsoft", group: "å¾®è½¯æœåŠ¡", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Microsoft.list", type: "classical", format: "text" },
    { name: "Apple", group: "è‹¹æœæœåŠ¡", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Apple.list", type: "classical", format: "text" },
    { name: "Telegram", group: "ç”µæŠ¥æ¶ˆæ¯", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Telegram.list", type: "classical", format: "text" },
    { name: "OpenAI", group: "OpenAi", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/OpenAi.list", type: "classical", format: "text" },
    { name: "AI_Global", group: "OpenAi", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/AI.list", type: "classical", format: "text" },
    { name: "Steam", group: "æ¸¸æˆå¹³å°", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Steam.list", type: "classical", format: "text" },
    { name: "Bilibili", group: "å“”å“©å“”å“©", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Bilibili.list", type: "classical", format: "text" },
    { name: "Bahamut", group: "å·´å“ˆå§†ç‰¹", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Bahamut.list", type: "classical", format: "text" },
    { name: "NeteaseMusic", group: "ç½‘æ˜“éŸ³ä¹", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/NetEaseMusic.list", type: "classical", format: "text" },
    { name: "YouTube", group: "æ²¹ç®¡è§†é¢‘", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/YouTube.list", type: "classical", format: "text" },
    { name: "Netflix", group: "å¥ˆé£è§†é¢‘", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Netflix.list", type: "classical", format: "text" },
    { name: "ProxyMedia", group: "å›½å¤–åª’ä½“", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyMedia.list", type: "classical", format: "text" },
    { name: "ProxyGFWlist", group: "èŠ‚ç‚¹é€‰æ‹©", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyGFWlist.list", type: "classical", format: "text" },
    { name: "ChinaMedia", group: "å›½å†…åª’ä½“", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaMedia.list", type: "classical", format: "text" },
    { name: "ChinaCompanyIp", group: "å…¨çƒç›´è¿", url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaCompanyIp.list", type: "classical", format: "text" },
];

let generatedNodes = [];
let currentTab = 'raw';

async function fetchIPInfo(ip, preferredIndex) {
    const totalProviders = apiProviders.length;
    let startIndex = 0;

    for (let i = startIndex; i < totalProviders; i++) {
        let currentIndex = (preferredIndex + i) % totalProviders;
        const provider = apiProviders[currentIndex];
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 1500); 
            const res = await fetch(provider.url(ip), { signal: controller.signal });
            clearTimeout(timeoutId);
            if (res.ok) {
                const data = await res.json();
                if (data.status === 'fail' && data.message === 'quota reached') throw new Error("Quota reached"); 
                const info = provider.parse(data);
                if (info.code) return { code: info.code, name: translateCountry(info.code, info.name), rawName: info.name };
            }
        } catch (e) {}
    }
    return { code: 'US', name: 'ç¾å›½', rawName: 'United States' }; 
}

async function generateNodes() {
    const sourceLink = document.getElementById('sourceNode').value.trim();
    const rawIps = document.getElementById('ipList').value.split('\n').filter(l => l.trim());
    const ips = [...new Set(rawIps)];
    
    if (ips.length === 0) return showToast("âš ï¸ è¯·è¾“å…¥IPåˆ—è¡¨", "#f87171");
    
    const btn = document.getElementById('genBtn');
    const progress = document.getElementById('progress-text');
    btn.disabled = true;
    generatedNodes = [];

    const BATCH_SIZE = 8; 
    showToast(`ğŸš€ å¼€å§‹å¤„ç† ${ips.length} ä¸ªå”¯ä¸€IP...`, "#60a5fa");

    for (let i = 0; i < ips.length; i += BATCH_SIZE) {
        const chunk = ips.slice(i, i + BATCH_SIZE);
        progress.innerText = `å¤„ç†ä¸­: ${i + 1} / ${ips.length}`;
        
        const promises = chunk.map(async (ip, idx) => {
            const globalIndex = i + idx;
            const info = await fetchIPInfo(ip, globalIndex);
            const flagEmoji = getFlagEmoji(info.code);
            const port = document.getElementById('defaultPort').value;
            const suffix = document.getElementById('tagSuffix').value;
            const nodeName = `${flagEmoji} ${info.name}${suffix}-${globalIndex + 1}`;
            return createNode(sourceLink || "vless://uuid@ip:443#æ¨¡æ¿", ip, port, nodeName, info.code, info.name);
        });

        const results = await Promise.all(promises);
        results.forEach(node => { if (node) generatedNodes.push(node); });
        
        updateOutput();
        await new Promise(r => setTimeout(r, 500)); 
    }
    
    btn.disabled = false;
    btn.innerText = "âš¡ å¼€å§‹è½¬æ¢ (è‡ªåŠ¨å»é‡)";
    progress.innerText = "å®Œæˆ";
    showToast(`âœ… å®Œæˆï¼Œå…± ${generatedNodes.length} ä¸ªèŠ‚ç‚¹`, "#4ade80");
}

function normalizeGroupName(rawName) {
    let clean = rawName.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27FF]|\uFE0F|[^\u4e00-\u9fa5a-zA-Z0-9]/g, "").toLowerCase();
    const mappings = {
        "ç”µæŠ¥æ¶ˆæ¯": ["ç”µæŠ¥", "telegram", "tg", "æ¶ˆæ¯", "ä¿¡æ¯"],
        "æ²¹ç®¡è§†é¢‘": ["æ²¹ç®¡", "youtube", "ytb", "è§†é¢‘"],
        "å¥ˆé£è§†é¢‘": ["å¥ˆé£", "netflix", "nf"],
        "OpenAi":   ["openai", "chatgpt", "gpt", "ai"],
        "å¾®è½¯æœåŠ¡": ["å¾®è½¯", "microsoft", "ms"],
        "è‹¹æœæœåŠ¡": ["è‹¹æœ", "apple"],
        "åº”ç”¨å‡€åŒ–": ["å¹¿å‘Š", "ad", "ban", "reject", "å‡€åŒ–", "æ‹¦æˆª"],
        "èŠ‚ç‚¹é€‰æ‹©": ["èŠ‚ç‚¹", "proxy", "select", "é€‰æ‹©"],
        "å›½å¤–åª’ä½“": ["å›½å¤–", "global", "media"], 
        "å›½å†…åª’ä½“": ["å›½å†…", "china", "cn"],
        "æ¼ç½‘ä¹‹é±¼": ["æ¼ç½‘", "final", "match", "other"]
    };
    for (const [standard, keywords] of Object.entries(mappings)) {
        if (keywords.some(k => clean.includes(k))) return standard;
    }
    const readable = rawName.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27FF]|\uFE0F/g, "").trim();
    if (hardcodedGroups.includes(readable)) return readable;
    return readable || rawName;
}

async function fetchAndApplyRules() {
    const ruleUrl = document.getElementById('ruleUrl').value.trim();
    if (!ruleUrl) return showToast("âš ï¸ è¯·è¾“å…¥è§„åˆ™é“¾æ¥", "#f87171");
    
    showToast("ğŸ“¥ æ­£åœ¨æŠ“å–...", "#60a5fa");
    try {
        const response = await fetch(ruleUrl);
        const iniContent = await response.text();
        const ruleMap = new Map(); 
        
        iniContent.split('\n').forEach(line => {
            if (line.trim().startsWith('ruleset=')) {
                const parts = line.replace('ruleset=', '').split(',');
                const groupName = normalizeGroupName(parts[0].trim());
                const url = parts[1].trim();
                let name = url.split('/').pop().split('.')[0].replace(/[^a-zA-Z0-9]/g, '');
                if (ruleMap.has(name)) name += "_" + Math.random().toString(36).substr(2, 4);
                const isList = url.endsWith('.list') || url.endsWith('.txt');
                ruleMap.set(name, { 
                    name, 
                    group: groupName, 
                    url,
                    type: isList ? 'classical' : 'classical', 
                    format: isList ? 'text' : 'yaml'
                });
            }
        });

        const newRules = Array.from(ruleMap.values());
        if (newRules.length > 0) {
            activeRules = newRules;
            showToast(`âœ… åŠ è½½ ${newRules.length} ä¸ªè§„åˆ™`, "#4ade80");
            if (currentTab === 'clash') updateOutput();
        }
    } catch (e) { showToast("âŒ åŠ è½½å¤±è´¥", "#f87171"); }
}

function createNode(link, ip, port, nodeName, countryCode, countryName) {
    if (!countryCode) countryCode = 'US';
    if (!countryName) countryName = 'ç¾å›½';
    try {
        let node = null;
        if (link.startsWith("vmess://")) {
            const config = JSON.parse(Base64.decode(link.replace("vmess://", "")));
            config.add = ip; config.port = parseInt(port); config.ps = nodeName;
            node = { type: "vmess", link: "vmess://" + Base64.encode(JSON.stringify(config)), name: nodeName, server: ip, port: port, secret: config.id, config };
        } else {
            const url = new URL(link);
            url.hostname = ip; url.port = port; url.hash = "#" + encodeURIComponent(nodeName);
            const secret = url.username || url.password;
            node = { type: url.protocol.replace(':',''), link: url.toString(), name: nodeName, server: ip, port: port, secret, config: url };
        }
        if(node) node.meta = { countryCode, countryName };
        return node;
    } catch (e) { return null; }
}

function parseNode(link) {
    try {
        let node = null;
        if (link.startsWith('vmess://')) {
            const config = JSON.parse(Base64.decode(link.replace('vmess://', '')));
            node = { type: 'vmess', link, name: config.ps, server: config.add, port: config.port, secret: config.id, config };
        } else {
            const url = new URL(link);
            const secret = url.username || url.password;
            node = { type: url.protocol.replace(':',''), link, name: decodeURIComponent(url.hash.substring(1)), server: url.hostname, port: url.port, secret, config: url };
        }
        return node;
    } catch(e) { return null; }
}

function getIconForGroup(name) {
    const Orz3 = "https://fastly.jsdelivr.net/gh/Orz-3/mini@master/Color/";
    const Xiaolin = "https://raw.githubusercontent.com/xiaolin-007/clash/main/icon/";
    const Verge = "https://raw.githubusercontent.com/clash-verge-rev/clash-verge-rev.github.io/main/docs/assets/icons/";
    const Koolson = "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/"; 
    
    for (const [code, cName] of Object.entries(countryMap)) {
        if (name.includes(cName) || name.includes(code)) {
            return getFlagIconUrl(code);
        }
    }

    const mapping = [
        // --- 1. æœ€å…·ä½“çš„å…³é”®è¯ï¼ˆé•¿è¯/ç‰¹å®šæœåŠ¡ï¼‰æ”¾åœ¨æœ€å‰é¢ï¼Œé˜²æ­¢è¢«æˆªèƒ¡ ---
        { key: "å¾®è½¯äº‘ç›˜", icon: Verge + "onedrive.svg" },
        { key: "OneDrive", icon: Verge + "onedrive.svg" },
        { key: "å¾®è½¯Bing", icon: Orz3 + "Bing.png" },
        { key: "Bing", icon: Orz3 + "Bing.png" },
        { key: "è°·æ­ŒFCM", icon: Orz3 + "Google.png" },
        { key: "FCM", icon: Orz3 + "Google.png" },
        { key: "ç½‘æ˜“éŸ³ä¹", icon: Koolson + "Netease_Music.png" },
        { key: "Netease", icon: Koolson + "Netease_Music.png" },
        { key: "å›½å¤–åª’ä½“", icon: Orz3 + "Global.png" },
        { key: "å›½å†…åª’ä½“", icon: Koolson + "Media.png" },
        { key: "å…¨çƒç›´è¿", icon: Verge + "link.svg" },
        { key: "å…¨çƒæ‹¦æˆª", icon: Verge + "block.svg" },

        // --- 2. ä¸“é¡¹åª’ä½“ä¸æœåŠ¡ ---
        { key: "OpenAi", icon: Orz3 + "OpenAI.png" },
        { key: "ChatGPT", icon: Orz3 + "OpenAI.png" },
        { key: "YouTube", icon: Orz3 + "YouTube.png" },
        { key: "æ²¹ç®¡", icon: Orz3 + "YouTube.png" },
        { key: "Netflix", icon: Orz3 + "Netflix.png" },
        { key: "å¥ˆé£", icon: Orz3 + "Netflix.png" },
        { key: "Bilibili", icon: Xiaolin + "bilibili.svg" }, 
        { key: "å“”å“©å“”å“©", icon: Xiaolin + "bilibili.svg" },
        { key: "Bahamut", icon: Xiaolin + "Bahamut.svg" },
        { key: "å·´å“ˆå§†ç‰¹", icon: Xiaolin + "Bahamut.svg" },
        { key: "Spotify", icon: Orz3 + "Spotify.png" },
        { key: "Telegram", icon: Orz3 + "Telegram.png" },
        { key: "ç”µæŠ¥", icon: Orz3 + "Telegram.png" },
        { key: "Steam", icon: Orz3 + "Steam.png" },
        { key: "æ¸¸æˆ", icon: Orz3 + "Steam.png" },
        { key: "Discord", icon: Orz3 + "Discord.png" },
        { key: "Twitter", icon: Orz3 + "Twitter.png" },

        // --- 3. é€šç”¨å‚å•†å…³é”®è¯ï¼ˆæ”¾åœ¨å…·ä½“æœåŠ¡åé¢ï¼‰ ---
        { key: "Microsoft", icon: Orz3 + "Microsoft.png" },
        { key: "å¾®è½¯", icon: Orz3 + "Microsoft.png" },
        { key: "Google", icon: Orz3 + "Google.png" },
        { key: "è°·æ­Œ", icon: Orz3 + "Google.png" },
        { key: "Apple", icon: Orz3 + "Apple.png" },
        { key: "è‹¹æœ", icon: Orz3 + "Apple.png" },

        // --- 4. åŠŸèƒ½æ€§ç­–ç•¥ç»„ ---
        { key: "èŠ‚ç‚¹é€‰æ‹©", icon: Koolson + "Proxy.png" },
        { key: "æ‰‹åŠ¨åˆ‡æ¢", icon: Orz3 + "Static.png" },
        { key: "è‡ªåŠ¨", icon: Orz3 + "Urltest.png" },
        { key: "Auto", icon: Orz3 + "Urltest.png" },
        { key: "æ•…éšœè½¬ç§»", icon: Orz3 + "Final.png" },
        { key: "æ¼ç½‘ä¹‹é±¼", icon: Orz3 + "Final.png" },
        { key: "Match", icon: Orz3 + "Final.png" },
        { key: "Select", icon: Orz3 + "Static.png" },
        { key: "åº”ç”¨å‡€åŒ–", icon: Koolson + "Advertising.png" },
        { key: "ChinaIP", icon: Orz3 + "China.png" },
        { key: "China", icon: Orz3 + "China.png" },
        { key: "Global", icon: Orz3 + "Global.png" },
        { key: "å›½å¤–", icon: Orz3 + "Global.png" },
        { key: "Cloudflare", icon: Orz3 + "Cloudflare.png" },

        // --- 5. å…œåº•åŸºç¡€åŠ¨ä½œ ---
        { key: "Reject", icon: Orz3 + "Reject.png" },
        { key: "æ‹¦æˆª", icon: Orz3 + "Reject.png" },
        { key: "å‡€åŒ–", icon: Orz3 + "Reject.png" },
        { key: "Direct", icon: Orz3 + "Direct.png" },
        { key: "ç›´è¿", icon: Orz3 + "Direct.png" }
    ];

    for (let item of mapping) {
        if (name.toLowerCase().includes(item.key.toLowerCase())) {
            return item.icon;
        }
    }
    return Orz3 + "Static.png";
}

function generateClashYaml(nodes) {
    // é‡‡ç”¨â€œå®Œç¾å¹³è¡¡â€çš„DNSé…ç½®ï¼šå›½å†…å¿«ï¼Œå›½å¤–é˜²æ³„éœ²ä¸”æœ‰å…œåº•
    let y = `port: 7890
socks-port: 7891
allow-lan: true
mode: Rule
log-level: info
external-controller: :9090
find-process-mode: strict
global-client-fingerprint: chrome
keep-alive-interval: 30
dns:
  enable: true
  ipv6: false
  listen: 0.0.0.0:1053
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - "*.lan"
    - "*.localhost"
  respect-rules: true
  cache-algorithm: arc
  use-system-hosts: false
  
  # 1. ç¡®ä¿èŠ‚ç‚¹åŸŸåæœ¬èº«èƒ½è¢«è§£æ
  proxy-server-nameserver:
    - https://dns.alidns.com/dns-query
    - https://doh.pub/dns-query

  # 2. é»˜è®¤ DNS (è®¾ä¸ºå›½å¤–ï¼è¿™æ ·æ¼ç½‘ä¹‹é±¼/æµ‹è¯•ç½‘ç«™ åªä¼šçœ‹åˆ°å›½å¤–DNS)
  nameserver:
    - https://8.8.8.8/dns-query
    - https://1.1.1.1/dns-query

  # 3. åˆ†æµç­–ç•¥ (æ ¸å¿ƒï¼šåªæœ‰å›½å†…ç½‘ç«™æ‰èµ°å›½å†…DNSï¼Œè§£å†³é€Ÿåº¦é—®é¢˜)
  nameserver-policy:
    "geosite:cn,private":
      - https://dns.alidns.com/dns-query
      - https://doh.pub/dns-query

  # 4. å…œåº• (ä¿æŒå›½å¤–ï¼Œé˜²æ±¡æŸ“)
  fallback:
    - https://dns.google/dns-query
    - https://dns.cloudflare.com/dns-query
  
  fallback-filter:
    geoip: true
    ipcidr:
      - 240.0.0.0/4

proxies:
`;

    nodes.forEach(n => {
        let name = `"${n.name.replace(/['"]/g, '')}"`;
        if (n.type === 'vless') {
            const p = Object.fromEntries(n.config.searchParams);
            y += `  - {name: ${name}, server: ${n.server}, port: ${n.port}, type: vless, uuid: "${n.secret}"`;
            if (p.sni) y += `, sni: "${p.sni}"`;
            y += `, skip-cert-verify: false, network: ${p.type || 'tcp'}`;
            if ((p.type || 'tcp') === 'ws') {
                let path = decodeURIComponent(p.path || '/');
                if (!path.includes('ed=2048')) path = path.includes('?') ? path + '&ed=2048' : path + '?ed=2048';
                const host = p.host || p.sni || n.server; 
                y += `, ws-opts: {path: "${path}", headers: {Host: "${host}"}}`;
            }
            y += `}\n`;
        } else if (n.type === 'trojan') {
            const p = Object.fromEntries(n.config.searchParams);
            y += `  - {name: ${name}, server: ${n.server}, port: ${n.port}, type: trojan, password: "${n.secret}"`;
            if (p.sni) y += `, sni: "${p.sni}"`;
            y += `, skip-cert-verify: false, network: ${p.type || 'tcp'}`;
            if ((p.type || 'tcp') === 'ws') {
                let path = decodeURIComponent(p.path || '/');
                if (!path.includes('ed=2048')) path = path.includes('?') ? path + '&ed=2048' : path + '?ed=2048';
                const host = p.host || p.sni || n.server;
                y += `, ws-opts: {path: "${path}", headers: {Host: "${host}"}}`;
            }
            y += `}\n`;
        } else if (n.type === 'vmess') {
            const c = n.config;
            y += `  - {name: ${name}, server: ${n.server}, port: ${n.port}, type: vmess, uuid: "${c.id}", alterId: 0, cipher: auto, tls: ${c.tls==='tls'}, network: ${c.net||'tcp'}, skip-cert-verify: true`;
            if (c.net === 'ws') {
                let path = c.path || '/';
                if (!path.includes('ed=2048')) path = path.includes('?') ? path + '&ed=2048' : path + '?ed=2048';
                y += `, ws-opts: {path: "${path}", headers: {Host: "${c.host || n.server}"}}`;
            }
            y += `}\n`;
        }
    });

    const dynamicGroups = {};
    const allNames = nodes.map(n => `      - "${n.name.replace(/['"]/g, '')}"`).join('\n');

    nodes.forEach(n => {
        let matchedName = null;
        if (n.meta && n.meta.countryName) {
            matchedName = n.meta.countryName;
        } else {
            for (const [code, cName] of Object.entries(countryMap)) {
                if (n.name.includes(cName) || n.name.includes(code)) {
                    matchedName = cName;
                    break;
                }
            }
        }
        if (matchedName) {
            const groupKey = matchedName + "èŠ‚ç‚¹"; 
            if (!dynamicGroups[groupKey]) dynamicGroups[groupKey] = [];
            dynamicGroups[groupKey].push(`      - "${n.name.replace(/['"]/g, '')}"`);
        }
    });

    let countryGroupYaml = "";
    let countryGroupNames = []; // ç”¨äºæ·»åŠ åˆ° "èŠ‚ç‚¹é€‰æ‹©" ç­‰ä¸»ç»„ä¸­

    for (const [groupName, proxies] of Object.entries(dynamicGroups)) {
        countryGroupNames.push(groupName);
        
        // 1. ç”Ÿæˆè¯¥å›½å®¶çš„ã€æ•…éšœè½¬ç§»ã€‘å­ç­–ç•¥ (éšè—åœ¨å†…éƒ¨ï¼Œæ ¸å¿ƒåŠŸèƒ½)
        // é€»è¾‘ï¼šæ­»å®ˆç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‚äº†æ‰æ¢ã€‚IP æå…¶ç¨³å®šã€‚
        const autoName = `${groupName}è‡ªåŠ¨`; 
        countryGroupYaml += `  - name: ${autoName}
    type: fallback
    icon: ${getIconForGroup(groupName)}
    url: http://www.gstatic.com/generate_204
    interval: 80000
    proxies:
${proxies.join('\n')}\n`;

        // 2. ç”Ÿæˆè¯¥å›½å®¶çš„ã€ä¸»é€‰å•ã€‘ (Select æ¨¡å¼)
        // é€»è¾‘ï¼šé»˜è®¤é€‰ä¸­ä¸Šé¢çš„â€œè‡ªåŠ¨â€ï¼Œä½†ä¹Ÿå…è®¸ä½ æ‰‹åŠ¨é€‰ç‰¹å®šèŠ‚ç‚¹
        countryGroupYaml += `  - name: ${groupName}
    type: select
    icon: ${getIconForGroup(groupName)}
    proxies:
      - ${autoName}     # <--- âœ… é»˜è®¤ç¬¬ä¸€é¡¹å°±æ˜¯â€œæ•…éšœè½¬ç§»â€ï¼Œç¨³å¦‚è€ç‹—
${proxies.join('\n')}\n`;
    }
    
    const countrySubGroups = countryGroupNames.map(n => `      - ${n}`).join('\n') || '      - DIRECT';

    y += `\nrule-providers:\n`;
    activeRules.forEach(rule => {
        y += `  ${rule.name}:\n    type: http\n    behavior: ${rule.type}\n    format: ${rule.format}\n    url: "${rule.url}"\n    path: ./ruleset/${rule.name}.${rule.format === 'text' ? 'list' : 'yaml'}\n    interval: 86400\n`;
    });

    y += `
proxy-groups:
  - name: èŠ‚ç‚¹é€‰æ‹©
    type: select
    icon: ${getIconForGroup("èŠ‚ç‚¹é€‰æ‹©")}
    proxies:
      - è‡ªåŠ¨é€‰æ‹©
      - æ•…éšœè½¬ç§»      # <--- âœ… æ–°å¢ï¼šä¸»èœå•åŒ…å«æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢
      - DIRECT

  - name: è‡ªåŠ¨é€‰æ‹©
    type: url-test
    icon: ${getIconForGroup("è‡ªåŠ¨é€‰æ‹©")}
    url: http://www.gstatic.com/generate_204
    interval: 80000
    tolerance: 50
    proxies:
${allNames}

  - name: æ•…éšœè½¬ç§»
    type: fallback    # <--- âœ… æ–°å¢ï¼šå…¨å±€æ•…éšœè½¬ç§»ç­–ç•¥
    icon: https://fastly.jsdelivr.net/gh/Orz-3/mini@master/Color/Final.png
    url: http://www.gstatic.com/generate_204
    interval: 80000
    proxies:
${allNames}

  - name: æ‰‹åŠ¨åˆ‡æ¢
    type: select
    icon: ${getIconForGroup("æ‰‹åŠ¨åˆ‡æ¢")}
    proxies:
${allNames}

  - name: ç”µæŠ¥æ¶ˆæ¯
    type: select
    icon: ${getIconForGroup("ç”µæŠ¥æ¶ˆæ¯")}
    proxies:
      - æ•…éšœè½¬ç§»      # <--- âœ… ä¼˜åŒ–ï¼šç”µæŠ¥ä¼˜å…ˆç”¨æ•…éšœè½¬ç§»
      - èŠ‚ç‚¹é€‰æ‹©
      - è‡ªåŠ¨é€‰æ‹©
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢
      - DIRECT

  - name: OpenAi
    type: select
    icon: ${getIconForGroup("OpenAi")}
    proxies:
      - æ•…éšœè½¬ç§»      # <--- âœ… ä¼˜åŒ–ï¼šChatGPT ä¼˜å…ˆç”¨æ•…éšœè½¬ç§»
      - èŠ‚ç‚¹é€‰æ‹©
      - è‡ªåŠ¨é€‰æ‹©
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: æ²¹ç®¡è§†é¢‘
    type: select
    icon: ${getIconForGroup("æ²¹ç®¡è§†é¢‘")}
    proxies:
      - èŠ‚ç‚¹é€‰æ‹©
      - è‡ªåŠ¨é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢
      - DIRECT

  - name: å¥ˆé£è§†é¢‘
    type: select
    icon: ${getIconForGroup("å¥ˆé£è§†é¢‘")}
    proxies:
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢
      - DIRECT

  - name: å·´å“ˆå§†ç‰¹
    type: select
    icon: ${getIconForGroup("å·´å“ˆå§†ç‰¹")}
    proxies:
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢
      - DIRECT

  - name: å“”å“©å“”å“©
    type: select
    icon: ${getIconForGroup("å“”å“©å“”å“©")}
    proxies:
      - å…¨çƒç›´è¿
${countrySubGroups}

  - name: å›½å¤–åª’ä½“
    type: select
    icon: ${getIconForGroup("å›½å¤–åª’ä½“")}
    proxies:
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
      - è‡ªåŠ¨é€‰æ‹©
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢
      - DIRECT

  - name: å›½å†…åª’ä½“
    type: select
    icon: ${getIconForGroup("å›½å†…åª’ä½“")}
    proxies:
      - DIRECT
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: è°·æ­ŒFCM
    type: select
    icon: ${getIconForGroup("è°·æ­ŒFCM")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: å¾®è½¯Bing
    type: select
    icon: ${getIconForGroup("å¾®è½¯Bing")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: å¾®è½¯äº‘ç›˜
    type: select
    icon: ${getIconForGroup("å¾®è½¯äº‘ç›˜")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: å¾®è½¯æœåŠ¡
    type: select
    icon: ${getIconForGroup("å¾®è½¯æœåŠ¡")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: è‹¹æœæœåŠ¡
    type: select
    icon: ${getIconForGroup("è‹¹æœæœåŠ¡")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: æ¸¸æˆå¹³å°
    type: select
    icon: ${getIconForGroup("æ¸¸æˆå¹³å°")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢

  - name: ç½‘æ˜“éŸ³ä¹
    type: select
    icon: ${getIconForGroup("ç½‘æ˜“éŸ³ä¹")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©

  - name: å…¨çƒç›´è¿
    type: select
    icon: ${getIconForGroup("å…¨çƒç›´è¿")}
    proxies:
      - DIRECT
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
      - è‡ªåŠ¨é€‰æ‹©

  - name: å…¨çƒæ‹¦æˆª
    type: select
    icon: ${getIconForGroup("å…¨çƒæ‹¦æˆª")}
    proxies:
      - REJECT
      - DIRECT

  - name: åº”ç”¨å‡€åŒ–
    type: select
    icon: ${getIconForGroup("åº”ç”¨å‡€åŒ–")}
    proxies:
      - REJECT
      - DIRECT

  - name: æ¼ç½‘ä¹‹é±¼
    type: select
    icon: ${getIconForGroup("æ¼ç½‘ä¹‹é±¼")}
    proxies:
      - èŠ‚ç‚¹é€‰æ‹©
      - æ•…éšœè½¬ç§»
      - å…¨çƒç›´è¿
      - è‡ªåŠ¨é€‰æ‹©
${countrySubGroups}
      - æ‰‹åŠ¨åˆ‡æ¢
${countryGroupYaml}
`;

    const groupMap = {};
    activeRules.forEach(r => {
        if (!hardcodedGroups.includes(r.group)) {
            if (!groupMap[r.group]) groupMap[r.group] = [];
            groupMap[r.group].push(r.name);
        }
    });

    Object.keys(groupMap).forEach(group => {
        y += `  - name: "${group}"\n    type: select\n    icon: ${getIconForGroup(group)}\n    proxies:\n      - èŠ‚ç‚¹é€‰æ‹©\n      - æ‰‹åŠ¨åˆ‡æ¢\n      - DIRECT\n`;
    });

    y += `\nrules:\n`;
    const processedRules = new Set();

    // ========== ä¼˜å…ˆçº§ 1: å±€åŸŸç½‘ä¸æ‹¦æˆª (æœ€å¿«åŒ¹é…) ==========
    y += `  - RULE-SET,Lan,å…¨çƒç›´è¿\n`;
    y += `  - RULE-SET,LS_Reject,åº”ç”¨å‡€åŒ–\n`;
    y += `  - RULE-SET,Advertising,åº”ç”¨å‡€åŒ–\n`;
    processedRules.add('Lan'); processedRules.add('LS_Reject'); processedRules.add('Advertising');

    // ========== ä¼˜å…ˆçº§ 2: AI æœåŠ¡ç¡¬åˆ†æµ (å¼ºåˆ¶ç¾å›½/æ”¯æŒåŒºåŸŸ) ==========
    // --- Claude ---
    y += `  - DOMAIN-SUFFIX,claude.ai,OpenAi\n`;
    y += `  - DOMAIN-SUFFIX,claude.com,OpenAi\n`;
    y += `  - DOMAIN-SUFFIX,anthropic.com,OpenAi\n`;
    
    // --- Gemini (Google AI) ---
    // ä¿®æ­£ï¼šå°† Gemini æ ¸å¿ƒåŸŸåç§»å…¥ OpenAi ç»„ï¼Œç¡®ä¿ä¸èµ°é¦™æ¸¯
    y += `  - DOMAIN-SUFFIX,gemini.google.com,OpenAi\n`;
    y += `  - DOMAIN-SUFFIX,bard.google.com,OpenAi\n`;
    y += `  - DOMAIN-KEYWORD,gemini,OpenAi\n`;
    y += `  - DOMAIN-KEYWORD,alkaliminer,OpenAi\n`; // Gemini çš„ç›¸å…³ API

    // --- ChatGPT ---
    y += `  - DOMAIN-SUFFIX,openai.com,OpenAi\n`;
    y += `  - DOMAIN-SUFFIX,chatgpt.com,OpenAi\n`;

    // ========== ä¼˜å…ˆçº§ 3: è°·æ­Œé€šç”¨åŸºç¡€æœåŠ¡ (èµ°æ™®é€šä»£ç†ç»„) ==========
    // è¿™äº›åŸŸåæ˜¯ Google åŸºç¡€ä¾èµ–ï¼Œé€šå¸¸é¦™æ¸¯èŠ‚ç‚¹é€Ÿåº¦æ›´å¿«ï¼Œæ‰€ä»¥æ”¾åœ¨ AI ç»„ä¹‹å
    y += `  - DOMAIN-SUFFIX,gstatic.com,èŠ‚ç‚¹é€‰æ‹©\n`;
    y += `  - DOMAIN-SUFFIX,googleapis.com,èŠ‚ç‚¹é€‰æ‹©\n`;
    y += `  - DOMAIN-SUFFIX,googleusercontent.com,èŠ‚ç‚¹é€‰æ‹©\n`;

    // ========== ä¼˜å…ˆçº§ 4: ç‰¹å®šæœåŠ¡è§„åˆ™é›† (Rule-Set æ¨¡å¼) ==========
    const specialNames = ['OpenAI', 'AI_Global', 'Telegram', 'YouTube', 'Netflix', 'Bilibili', 'Bahamut', 'Steam', 'NeteaseMusic', 'GoogleFCM', 'Bing', 'OneDrive', 'Microsoft', 'Apple', 'ProxyMedia', 'ChinaMedia'];
    
    activeRules.forEach(r => {
        if (processedRules.has(r.name)) return;
        
        let target = null;
        // ç¡®ä¿ AI ç›¸å…³è§„åˆ™é›†å…¨éƒ¨æŒ‡å‘ OpenAi ç»„
        if (r.name === 'OpenAI' || r.name === 'AI_Global' || r.group === 'OpenAi') target = 'OpenAi';
        else if (r.name === 'Telegram') target = 'ç”µæŠ¥æ¶ˆæ¯';
        else if (r.name === 'YouTube') target = 'æ²¹ç®¡è§†é¢‘';
        else if (r.name === 'Netflix') target = 'å¥ˆé£è§†é¢‘';
        else if (r.name === 'Bilibili') target = 'å“”å“©å“”å“©';
        else if (r.name === 'Bahamut') target = 'å·´å“ˆå§†ç‰¹';
        else if (r.name === 'NeteaseMusic') target = 'ç½‘æ˜“éŸ³ä¹';
        else if (r.name === 'Steam') target = 'æ¸¸æˆå¹³å°';
        else if (r.group === 'å¾®è½¯Bing' || r.name === 'Bing') target = 'å¾®è½¯Bing';
        else if (r.group === 'å¾®è½¯äº‘ç›˜' || r.name === 'OneDrive') target = 'å¾®è½¯äº‘ç›˜';
        else if (r.group === 'å¾®è½¯æœåŠ¡' || r.name === 'Microsoft') target = 'å¾®è½¯æœåŠ¡';
        else if (r.group === 'è‹¹æœæœåŠ¡' || r.name === 'Apple') target = 'è‹¹æœæœåŠ¡';
        else if (r.group === 'è°·æ­ŒFCM' || r.name === 'GoogleFCM') target = 'è°·æ­ŒFCM';
        else if (r.group === 'å›½å¤–åª’ä½“' || r.name === 'ProxyMedia') target = 'å›½å¤–åª’ä½“';
        else if (r.group === 'å›½å†…åª’ä½“' || r.name === 'ChinaMedia') target = 'å›½å†…åª’ä½“';

        if (target && target !== 'å…¨çƒç›´è¿') {
            y += `  - RULE-SET,${r.name},${target}\n`;
            processedRules.add(r.name);
        }
    });

    // ========== ä¼˜å…ˆçº§ 5: é€šç”¨ä»£ç†å…œåº• (LS_Proxy) ==========
    activeRules.forEach(r => {
        if (processedRules.has(r.name)) return;
        if (['LS_Proxy', 'ProxyGFWlist', 'LS_NonCN'].includes(r.name)) {
            y += `  - RULE-SET,${r.name},èŠ‚ç‚¹é€‰æ‹©\n`;
            processedRules.add(r.name);
        }
    });

    // ========== ä¼˜å…ˆçº§ 6: ç›´è¿è§„åˆ™ä¸æœ€åå…œåº• ==========
    activeRules.forEach(r => {
        if (processedRules.has(r.name)) return;
        if (['LS_Direct', 'UnBan', 'ChinaCompanyIp'].includes(r.name) || r.group === 'å…¨çƒç›´è¿') {
            y += `  - RULE-SET,${r.name},å…¨çƒç›´è¿\n`;
            processedRules.add(r.name);
        }
    });

    y += `  - GEOSITE,cn,DIRECT\n`;
    y += `  - GEOIP,CN,DIRECT\n`;
    y += `  - DOMAIN-SUFFIX,cn,DIRECT\n`;
    y += `  - MATCH,æ¼ç½‘ä¹‹é±¼\n`;

    return y;
}

// ----------------------------------------------------------------------------------
//   Clash -> V2Ray åå‘è§£ææ ¸å¿ƒé€»è¾‘ (ä¿®å¤ç‰ˆ)
// ----------------------------------------------------------------------------------

function parseClashLine(line) {
    try {
        const getKey = (key) => {
            const regex = new RegExp(`${key}:\\s*([^,}]+)`);
            const match = line.match(regex);
            return match ? match[1].replace(/['"]/g, '').trim() : null;
        };
        const getWsPath = () => {
            const match = line.match(/path:\s*['"]?([^'",}]+)['"]?/);
            return match ? match[1] : null;
        };
        const getWsHost = () => {
            const match = line.match(/headers:\s*\{.*?Host:\s*['"]?([^'",}]+)['"]?/i);
            return match ? match[1] : null;
        };

        const type = getKey('type');
        const name = getKey('name');
        const server = getKey('server');
        const port = getKey('port');
        const uuid = getKey('uuid') || getKey('password');
        const network = getKey('network') || 'tcp';
        const sni = getKey('sni');
        const tls = line.includes('tls: true') || type === 'trojan';

        if (!server || !port) return null;

        let link = "";
        
        if (type === 'vmess') {
            const alterId = getKey('alterId') || 0;
            const wsPath = getWsPath() || '/';
            const wsHost = getWsHost() || sni || server;
            
            const config = {
                v: "2", ps: name, add: server, port: parseInt(port), id: uuid,
                aid: alterId, scy: "auto", net: network, type: "none",
                host: network === 'ws' ? wsHost : "",
                path: network === 'ws' ? wsPath : "",
                tls: tls ? "tls" : ""
            };
            link = "vmess://" + Base64.encode(JSON.stringify(config));
        } else if (type === 'vless' || type === 'trojan') {
            let params = [];
            params.push(`type=${network}`);
            if (tls) params.push(`security=tls`);
            if (sni) params.push(`sni=${sni}`);
            if (network === 'ws') {
                const wsPath = getWsPath();
                const wsHost = getWsHost() || sni;
                if (wsPath) params.push(`path=${encodeURIComponent(wsPath)}`);
                if (wsHost) params.push(`host=${wsHost}`);
            }
            link = `${type}://${uuid}@${server}:${port}?${params.join('&')}#${encodeURIComponent(name)}`;
        }

        if (link) {
            return {
                type: type, link: link, name: name, server: server, port: port, secret: uuid,
                config: type === 'vmess' ? {} : new URL(link)
            };
        }
    } catch (e) { console.error("è§£æè¡Œå¤±è´¥:", e); return null; }
}

function clashToLinks(yamlContent) {
    const lines = yamlContent.split('\n');
    let inProxies = false;
    let convertedNodes = [];

    for (let line of lines) {
        line = line.trim();
        if (line.startsWith('proxies:')) { inProxies = true; continue; }
        if (inProxies && (line.startsWith('proxy-groups:') || line.startsWith('rules:'))) break;
        if (inProxies && line.startsWith('-')) {
            const node = parseClashLine(line);
            if (node) convertedNodes.push(node);
        }
    }

    if (convertedNodes.length === 0) return showToast("âš ï¸ æœªè¯†åˆ«åˆ°æœ‰æ•ˆèŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥æ ¼å¼", "#f87171");

    generatedNodes = convertedNodes;
    currentTab = 'raw';
    updateTabsUI('raw');
    updateOutput();
    showToast(`âœ… æˆåŠŸè½¬æ¢ ${convertedNodes.length} ä¸ªèŠ‚ç‚¹`, "#4ade80");
}

function updateOutput() {
    const area = document.getElementById('outputArea');
    if (generatedNodes.length === 0) return;
    if (currentTab === 'raw') area.value = generatedNodes.map(n => n.link).join('\n');
    else if (currentTab === 'b64') area.value = Base64.encode(generatedNodes.map(n => n.link).join('\n'));
    else if (currentTab === 'clash') area.value = generateClashYaml(generatedNodes);
    document.getElementById('genCountDisplay').innerText = `${generatedNodes.length} ä¸ªèŠ‚ç‚¹`;
}

function switchTab(tab) { currentTab = tab; updateTabsUI(tab); updateOutput(); }
function updateTabsUI(tab) { document.querySelectorAll('.tab').forEach((t, i) => { t.classList.remove('active'); if ((tab==='raw'&&i===0)||(tab==='b64'&&i===1)||(tab==='clash'&&i===2)) t.classList.add('active'); }); }
function independentTransform() { const c = document.getElementById('outputArea').value.trim(); if(!c)return showToast("âš ï¸ å†…å®¹ä¸ºç©º","#f87171"); if(c.startsWith('port:') || c.includes('proxies:')) clashToLinks(c); else linksToClash(c); }
function linksToClash(t) { generatedNodes = t.split('\n').filter(l=>l.includes('://')).map(l=>parseNode(l.trim())).filter(n=>n); currentTab='clash'; updateTabsUI('clash'); updateOutput(); showToast(`âœ… è½¬æ¢ ${generatedNodes.length} ä¸ª`,"#4ade80"); }
function cleanAndExtract() { const r = document.getElementById('ipList').value; const s = new Set(); r.split(/[\r\n]+/).forEach(l=>{const i=l.match(/(?:[0-9]{1,3}\.){3}[0-9]{1,3}/);if(i)s.add(i[0])}); document.getElementById('ipList').value=Array.from(s).join('\n'); showToast(`âœ… æå– ${s.size} IP`,"#4ade80"); }
function showToast(m,c) { const e=document.getElementById('status-toast'); e.innerText=m; e.style.color=c; e.style.opacity=1; setTimeout(()=>e.style.opacity=0,3000); }
function copyResult() { document.getElementById('outputArea').select(); document.execCommand('copy'); showToast("ğŸ“‹ å·²å¤åˆ¶","#4ade80"); }
function downloadResult() { const b=new Blob([document.getElementById('outputArea').value],{type:"text/plain"}); const a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=currentTab==='clash'?"clash.yaml":"nodes.txt"; a.click(); }
</script>
</body>
</html>